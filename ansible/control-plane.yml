- name: Inicializar o Kubernetes no Control-Plane
  hosts: control-plane
  become: true
  tasks:
    - name: Verificar se o Kubernetes já foi inicializado
      stat:
        path: /etc/kubernetes/admin.conf
      register: kubernetes_initialized

    - name: Inicializar o Kubernetes control-plane
      command: kubeadm init --pod-network-cidr=10.244.0.0/16
      register: kubeadm_init
      when: not kubernetes_initialized.stat.exists  # Executar apenas se o arquivo não existir

    - name: Configurar kubectl para o usuario root
      shell: |
        mkdir -p $HOME/.kube
        cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
        chown $(id -u):$(id -g) $HOME/.kube/config
      when: kubeadm_init is defined and kubeadm_init.changed  # Executar apenas se o kubeadm_init tiver sido alterado

    - name: Extrair comando de join do Kubernetes
      command: kubeadm token create --print-join-command
      register: join_command
      when: kubeadm_init is defined and kubeadm_init.changed  # Executar apenas se o kubeadm_init tiver sido alterado

    - name: Salvar comando de join para uso posterior
      local_action: copy content="{{ join_command.stdout }}" dest="/tmp/join_command.txt"
      when: kubeadm_init is defined and kubeadm_init.changed  # Executar apenas se o kubeadm_init tiver sido alterado
